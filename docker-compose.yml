x-teranode-settings:
  &teranode-settings
  environment:
    GOGC: "200" # increase this value to reduce CPU pressure at the cost of increased memory requirements
    network: "teratestnet"
    # blocks limited to 1GB in size, to allow for more participants with smaller hardware on teratestnet
    blockmaxsize: "1073741824"
    excessiveblocksize: "1073741824"
    minminingtxfee: "0"
    # quick catchup, specific to teratestnet, disable this for other networks
    blockvalidation_catchup_allow_quick_validation: "true"
    blockvalidation_catchup_checkpoint_hash: "0000000000c4eaa5d9bc414202eee6ab3e5f7c567fe0cbf0a8ffca6919a702d9"
    blockvalidation_catchup_checkpoint_height: "5636"
    # see https://github.com/bsv-blockchain/teranode/blob/1801dca90675824e73f7be64b2810b16b6475ecc/settings.conf#L838-L853
    # defaults to "off" for safety in shared environments, "client" or "server" is preferred for best p2p connectivity
    # p2p_dht_mode: "off"
    # logLevel: "DEBUG"

networks:
  teranode-network:
    name: my-teranode-network
    # if your docker setup supports IPv6, you can enable it here
    # enable_ipv6: true

volumes:
  nginx-cache:
  postgres-data:
  aerospike-data:
  aerospike-smd:
  aerospike-asmt:
  teranode-data:
  prometheus-data:
  grafana-data:

services:
  # Teranode micro-services
  blockchain:
    extends:
      file: ./base/docker-teranode.yml
      service: blockchain
    <<: *teranode-settings

  asset:
    extends:
      file: ./base/docker-teranode.yml
      service: asset
    <<: *teranode-settings

  asset-cache:
    extends:
      file: ./base/docker-services.yml
      service: asset-cache

  rpc:
    extends:
      file: ./base/docker-teranode.yml
      service: rpc
    <<: *teranode-settings

  subtreevalidation:
    extends:
      file: ./base/docker-teranode.yml
      service: subtreevalidation
    <<: *teranode-settings

  blockvalidation:
    extends:
      file: ./base/docker-teranode.yml
      service: blockvalidation
    <<: *teranode-settings

  blockassembly:
    extends:
      file: ./base/docker-teranode.yml
      service: blockassembly
    <<: *teranode-settings

  peer:
    extends:
      file: ./base/docker-teranode.yml
      service: peer
    <<: *teranode-settings

  pruner:
    extends:
      file: ./base/docker-teranode.yml
      service: pruner
    <<: *teranode-settings

  propagation:
    extends:
      file: ./base/docker-teranode.yml
      service: propagation
    <<: *teranode-settings

  # uses lots of disk space
  #  blockpersister:
  #    extends:
  #      file: ./base/docker-teranode.yml
  #      service: blockpersister
  #    <<: *teranode-settings

  # shared services
  postgres:
    extends:
      file: ./base/docker-services.yml
      service: postgres

  kafka-shared:
    extends:
      file: ./base/docker-services.yml
      service: kafka-shared

  kafka-console-shared:
    extends:
      file: ./base/docker-services.yml
      service: kafka-console-shared

  aerospike:
    extends:
      file: ./base/docker-services.yml
      # Community Edition
      # service: aerospike
      # Enterprise Edition, evaluation mode, single node
      service: aerospike-ee

  aerospike-exporter:
    extends:
      file: ./base/docker-services.yml
      service: aerospike-exporter

  prometheus:
    extends:
      file: ./base/docker-services.yml
      service: prometheus

  grafana:
    extends:
      file: ./base/docker-services.yml
      service: grafana

  # CPU Miner (optional - configured via startup script)
  cpuminer:
    image: ghcr.io/bitcoin-sv/cpuminer:latest
    container_name: cpuminer
    networks:
      - teranode-network
    environment:
      MINING_ENABLED: "${MINING_ENABLED:-false}"
      MINING_ADDRESS: "${MINING_ADDRESS:-}"
      MINING_SIG: "${MINING_SIG:-}"
      RPC_USER: "${RPC_USER:-bitcoin}"
      RPC_PASS: "${RPC_PASS:-bitcoin}"
    entrypoint: ["/bin/sh", "-c"]
    command: >
      "
      if [ \"$$MINING_ENABLED\" = \"true\" ] && [ -n \"$$MINING_ADDRESS\" ]; then
        echo 'Starting CPU miner...';
        echo 'Mining address: '$$MINING_ADDRESS;
        echo 'Miner Tag: '$$MINING_SIG;
        exec ./minerd --algo=sha256d --always-gmc --url=http://rpc:9292 --userpass=$$RPC_USER:$$RPC_PASS --coinbase-addr=$$MINING_ADDRESS --coinbase-sig=\"$$MINING_SIG\" --threads=2 --retries=1 --retry-pause=5;
      else
        echo 'Mining disabled or not configured. Container will exit.';
        exit 0;
      fi
      "
    profiles:
      - mining
    restart: unless-stopped
    depends_on:
      rpc:
        condition: service_healthy

  seeder:
    extends:
      file: ./base/docker-teranode.yml
      service: seeder
    <<: *teranode-settings
