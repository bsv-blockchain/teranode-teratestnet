x-teranode-settings:
  &teranode-settings
  environment:
    GOGC: "200" # increase this value to reduce CPU pressure at the cost of increased memory requirements
    network: "teratestnet"
    # blocks mined limited to 1GB in size, to allow for more participants with smaller hardware on teratestnet
    blockmaxsize: "1073741824"
    minminingtxfee: "0"
    p2p_dht_mode: "client" # switch this to server if you have a public IP and want to host a DHT node
    # the p2p_relay_peers aren't strictly required, but help with speed up discovering other peers
    p2p_relay_peers: "/dns4/teranode-eks-ttn-us-1-p2p.bsvb.tech/tcp/9905/p2p/12D3KooWFj5nh1m3iAooxnfp5VvDtufYajTpBSopUt7anj4XLqJp|/dns4/teranode-eks-ttn-eu-1-p2p.bsvb.tech/tcp/9905/p2p/12D3KooWDnQoDerA2KC8xD5hDqiSp21zf9zS5ezM32wuXgLUaden"
    # logLevel: "DEBUG"

networks:
  teranode-network:
    name: my-teranode-network
    # if your docker setup supports IPv6, you can enable it here
    # enable_ipv6: true

volumes:
  nginx-cache:
  postgres-data:
  aerospike-data:
  aerospike-smd:
  aerospike-asmt:
  teranode-data:
  prometheus-data:
  grafana-data:

services:
  # Teranode micro-services
  blockchain:
    extends:
      file: ./base/docker-teranode.yml
      service: blockchain
    <<: *teranode-settings

  asset:
    extends:
      file: ./base/docker-teranode.yml
      service: asset
    <<: *teranode-settings

  asset-cache:
    extends:
      file: ./base/docker-services.yml
      service: asset-cache

  rpc:
    extends:
      file: ./base/docker-teranode.yml
      service: rpc
    <<: *teranode-settings

  subtreevalidation:
    extends:
      file: ./base/docker-teranode.yml
      service: subtreevalidation
    <<: *teranode-settings

  blockvalidation:
    extends:
      file: ./base/docker-teranode.yml
      service: blockvalidation
    <<: *teranode-settings

  blockassembly:
    extends:
      file: ./base/docker-teranode.yml
      service: blockassembly
    <<: *teranode-settings

  peer:
    extends:
      file: ./base/docker-teranode.yml
      service: peer
    <<: *teranode-settings

  propagation:
    extends:
      file: ./base/docker-teranode.yml
      service: propagation
    <<: *teranode-settings

  # uses lots of disk space
  #  blockpersister:
  #    extends:
  #      file: ../base/docker-teranode.yml
  #      service: blockpersister
  #    <<: *teranode-settings

  # shared services
  postgres:
    extends:
      file: ./base/docker-services.yml
      service: postgres

  kafka-shared:
    extends:
      file: ./base/docker-services.yml
      service: kafka-shared

  kafka-console-shared:
    extends:
      file: ./base/docker-services.yml
      service: kafka-console-shared

  aerospike:
    extends:
      file: ./base/docker-services.yml
      # Community Edition
      # service: aerospike
      # Enterprise Edition, evaluation mode, single node
      service: aerospike-ee

  aerospike-exporter:
    extends:
      file: ./base/docker-services.yml
      service: aerospike-exporter

  prometheus:
    extends:
      file: ./base/docker-services.yml
      service: prometheus

  grafana:
    extends:
      file: ./base/docker-services.yml
      service: grafana

  # CPU Miner (optional - configured via startup script)
  cpuminer:
    image: ghcr.io/bitcoin-sv/cpuminer:latest
    container_name: cpuminer
    networks:
      - teranode-network
    environment:
      MINING_ENABLED: "${MINING_ENABLED:-false}"
      MINING_ADDRESS: "${MINING_ADDRESS:-}"
      MINING_SIG: "${MINING_SIG:-}"
      RPC_USER: "${RPC_USER:-bitcoin}"
      RPC_PASS: "${RPC_PASS:-bitcoin}"
    entrypoint: ["/bin/sh", "-c"]
    command: >
      "
      if [ \"$$MINING_ENABLED\" = \"true\" ] && [ -n \"$$MINING_ADDRESS\" ]; then
        echo 'Starting CPU miner...';
        echo 'Mining address: '$$MINING_ADDRESS;
        echo 'Miner Tag: '$$MINING_SIG;
        exec ./minerd --algo=sha256d --always-gmc --url=http://rpc:9292 --userpass=$$RPC_USER:$$RPC_PASS --coinbase-addr=$$MINING_ADDRESS --coinbase-sig=\"$$MINING_SIG\" --threads=2 --retries=1 --retry-pause=5;
      else
        echo 'Mining disabled or not configured. Container will exit.';
        exit 0;
      fi
      "
    profiles:
      - mining
    restart: unless-stopped
    depends_on:
      rpc:
        condition: service_healthy

  seeder:
    extends:
      file: ./base/docker-teranode.yml
      service: seeder
    <<: *teranode-settings
