# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a Docker-based deployment system for running Teranode instances on the Teratestnet network. Teranode is a highly scalable Bitcoin SV node implementation, and this repository provides containerized deployment with all required microservices.

## Commands

### Deployment and Management
```bash
# Main deployment (interactive setup)
./start-teratestnet.sh

# Deploy without ngrok (if you have a public domain)
./start-teratestnet.sh --no-ngrok

# Service management
docker compose up -d              # Start all services
docker compose down              # Stop all services
docker compose down -v           # Stop and remove all data volumes
docker compose ps                # Check service status
docker compose logs [service]    # View logs for a specific service
docker compose restart [service] # Restart a specific service
```

### Health Checks and Testing
```bash
# Service health endpoints
curl http://localhost:8000/health  # Teranode health check
curl http://localhost:9292         # RPC endpoint test
curl http://localhost:9090         # Prometheus metrics
curl http://localhost:3000         # Grafana dashboard

# FSM state management
docker exec blockchain teranode-cli getfsmstate
docker exec blockchain teranode-cli setfsmstate --fsmstate RUNNING
```

### Development Commands
```bash
# Start CPU miner (optional)
./scripts/start-deps.sh cpuminer

# View ngrok tunnel status (if using ngrok)
curl http://localhost:4040
```

## Architecture

The system uses a microservices architecture with Docker Compose orchestration:

### Core Teranode Services
- **blockchain**: Core blockchain processing (port 8087) - central service that all others depend on
- **asset**: Asset data retrieval (port 8090)
- **rpc**: JSON-RPC interface (port 9292)
- **peer**: P2P networking (port 9905)
- **subtreevalidation**: Transaction validation (port 8086)
- **blockvalidation**: Block validation (port 8088)
- **blockassembly**: Block assembly (port 8085)

### Infrastructure Services
- **postgres**: Blockchain metadata storage (port 5432)
- **aerospike**: UTXO storage (ports 3000-3002)
- **kafka-shared**: Message streaming via Redpanda (port 9092)
- **asset-cache**: Nginx reverse proxy for asset service (port 8000)
- **prometheus**: Metrics collection (port 9090)
- **grafana**: Metrics visualization (port 3005)

All services communicate via the `my-teranode-network` Docker network. The blockchain service is the central dependency - other Teranode services wait for it to be healthy before starting.

## Key Configuration Files
- `docker-compose.yml`: Service orchestration and dependencies
- `base/settings_local.conf`: Main Teranode configuration (auto-generated by start script)
- `base/aerospike.conf`: Aerospike database configuration
- `base/prometheus.yml`: Monitoring configuration

## Important Notes
- The `start-teratestnet.sh` script handles all initial configuration including ngrok setup, RPC credentials, and domain configuration
- Data is persisted in Docker volumes under `${DATA_PATH}` (defaults to current directory)
- Services use health checks and automatic restart policies for resilience
- The system requires ports 8000, 9905, and 9292 to be accessible (configured automatically with ngrok or manually with custom domain)